#!/usr/bin/env bash

if ! (sed --version 2>/dev/null | grep -q GNU)
then
	if which gsed &>/dev/null
	then
		sed=gsed
	else
		echo "GNU sed not found." >&2
		exit 1
	fi
fi

pipe=pipe
trap "rm -f $pipe" EXIT
mkfifo $pipe

phase=1
method=
path=
cat $pipe | {
	while :
	do
		if [[ $phase -eq 1 ]]
		then
			declare -A header
			read request
			method=$(echo $request | cut -d' ' -f1)
			path="$(pwd)$(echo $request | cut -d' ' -f2)"
			((phase++))
		elif [[ $phase -eq 2 ]]
		then
			read line
			if [[ $line = $(echo -ne "\r") ]]
			then
				((phase++))
			else
				head=$(echo -n $line | tr -d '\r' | tr -d '\n')
				key=$(echo -n $head | $sed -r "s/ *$//;s/([^:]*?): *(.*)$/\1/")
				val=$(echo -n $head | $sed -r "s/ *$//;s/([^:]*?): *(.*)$/\2/")
				header[$key]="$val"
			fi
		elif [[ $phase -eq 3 ]]
		then
			echo 'HTTP/1.1 200 OK'
			if [[ ${path##*.} = "html" ]]
			then
				echo 'Content-Type: text/html'
			elif [[ ${path##*.} = "png" ]]
			then
				echo 'Content-Type: image/png'
			else
				echo 'Content-Type: application/octet-stream'
			fi
			echo "Content-Length: $(wc -c $path | awk '{print $1}')"
			echo
			cat $path
			phase=1
			unset header
		fi
	done
} | nc -kl ${port:-3000} > $pipe
