#!/usr/bin/env bash -x

temp=$(mktemp)
trap "rm -f $temp" EXIT

phase=1
method=
path=
declare -A header

while :
do
	# Phase 1: Request Line
	if [[ $phase -eq 1 ]]
	then
		read request_line
		method=${request_line%% *}
		path="$PWD${request_line#* }"
		path="${request_uri%% *}"
		((phase++))
	# Phase 2: Request Headers
	elif [[ $phase -eq 2 ]]
	then
		read line
		if [[ $line = $(printf "\r") ]]
		then
			((phase++))
		else
			head=${line%%\r\n}
			key="${head%%: *}"
			val="${head#*: }"
			header[$key]="$val"
		fi
	# Phase 3: Request Body
	elif [[ $phase -eq 3 ]]
	then
		if ! [[ -z ${header[Content-Length]} ]]
		then
			read -rd' ' -n${header[Content-Length]} body
		fi
		((phase++))
	# Phase 4: Response
	elif [[ $phase -eq 4 ]]
	then
		# avoid path traversal
		if ! [[ "$(realpath "$path")" =~ ^$PWD ]]
		then
			echo 'HTTP/1.1 403 Forbidden'
			echo 'Content-Length: 0'
			echo
		# $path is not a regular file
		elif ! [[ -f "$path" ]]
		then
			echo 'HTTP/1.1 404 Not Found'
			echo 'Content-Length: 0'
			echo
		# $path is not readable
		elif ! [[ -r "$path" ]]
		then
			echo 'HTTP/1.1 403 Forbidden'
			echo 'Content-Length: 0'
			echo
		# OK
		else
			# set mime type
			if [[ ${path##*.} = "html" ]]
			then
				mime='text/html'
			elif [[ ${path##*.} = "css" ]]
			then
				mime='text/css'
			elif [[ ${path##*.} = "js" ]]
			then
				mime='text/javascript'
			elif [[ ${path##*.} = "txt" ]]
			then
				mime='text/plain'
			elif [[ ${path##*.} = "png" ]]
			then
				mime='image/png'
			elif [[ ${path##*.} = "jpg" ]] || [[ ${path##*.} = "jpeg" ]]
			then
				mime='image/jpeg'
			else
				mime='application/octet-stream'
			fi
			# send response
			echo 'HTTP/1.1 200 OK'
			echo "Content-Type: $mime"
			# Check Accept-Encoding in order
			while ! [[ -z "${header[Accept-Encoding]}" ]]
			do
				if [[ "${header[Accept-Encoding]%%, *}" = gzip ]] && which gzip &>/dev/null
				then
					cat $path | gzip --best > $temp
					stat=($(ls -l $temp))
					echo "Content-Length: ${stat[4]}"
					echo "Content-Encoding: gzip"
					echo
					cat $temp
					break
				elif [[ "${header[Accept-Encoding]%%, *}" = deflate ]] && which pigz &>/dev/null
				then
					pigz -cz --best $path > $temp
					stat=($(ls -l $temp))
					echo "Content-Length: ${stat[4]}"
					echo "Content-Encoding: deflate"
					echo
					cat $temp
					break
				fi
				header[Accept-Encoding]="${header[Accept-Encoding]#*, }"
			done
			# not compressed (= "Accept-Encoding: identity")
			if [[ -z "${header[Accept-Encoding]}" ]]
			then
				stat=($(ls -l $path))
				echo "Content-Length: ${stat[4]}"
				echo
				cat $path
			fi
		fi
		exit
	fi
done
